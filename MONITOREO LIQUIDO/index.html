<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoreo ‚Äì Salidas L√≠quidos</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
  body{
    font-family:'Poppins',sans-serif;
    margin:0; padding:12px;
    min-height:100vh;
    background: linear-gradient(to right,#00416A,#E4E5E6);
    position: relative;
  }
  body::before{
    content:"";
    position: fixed;
    top:50%; left:50%;
    transform: translate(-50%,-50%);
    width: clamp(500px, 60vw, 1000px);
    height: auto;
    background: url('logo_proveedora.webp') no-repeat center center;
    background-size: contain;
    opacity: 0.08;
    z-index: 0;
    pointer-events: none;
  }

  h1{ 
    text-align:center; 
    color:white; 
    margin:10px 0; 
    position: relative;
    z-index: 1; 
  }
  .tarjeta{
    background: rgba(255,255,255,0.9);
    border-radius:10px; 
    padding:10px 14px; 
    box-shadow:0 2px 5px rgba(0,0,0,0.15);
    margin:14px auto;
    font-size:13px;
    position: relative;
    z-index: 1;
    max-width: 900px;
    width: 95%;
  }
  .tarjeta h2{ margin:0; font-size:15px; color:#00416A }
  .productos{ width:100%; border-collapse:collapse; margin-top:6px; font-size:12px }
  .productos th, .productos td{
    border:1px solid #ccc; padding:4px; text-align:center;
  }
  .productos th{ background:#00416A; color:white; font-size:12px }
  .firmas{ display:flex; justify-content:space-between; margin-top:8px; gap:8px }
  .firma-box{ text-align:center; flex:1 }
  .firma-box img{ max-width:120px; max-height:60px; border:1px solid #ccc }
  .btn-imprimir{
    margin-top:8px; padding:5px 10px; border:none;
    background:#0c6cbd; color:white; border-radius:6px;
    cursor:pointer; font-size:12px;
  }

  /* impresi√≥n de toda la p√°gina (no se usa para el ticket del popup) */
  @media print {
    body { background: white !important; margin: 0; padding: 0; font-size: 10pt; width: 58mm; }
    h1, .btn-imprimir, body::before { display: none; }
    .tarjeta { display:none; }
  }
  </style>
</head>
<body>
  <h1>Monitoreo de Salidas ‚Äì Almac√©n L√≠quidos</h1>
  <div id="contenedor"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Configura tu Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const contenedor = document.getElementById("contenedor");

    // üî• Monitoreo en tiempo real
    function cargarSalidasTiempoReal(){
      const q = query(
        collection(db,"almacenes/Almacen_Liquidos/salidas"),
        orderBy("folio","desc")
      );

      onSnapshot(q, (snapshot)=>{
        contenedor.innerHTML = "";
        snapshot.forEach(doc=>{
          const data = doc.data();

          const div = document.createElement("div");
          div.className="tarjeta";
          // guardamos payload para la impresi√≥n exacta
          div.dataset.payload = JSON.stringify(data);

          div.innerHTML=`
            <h2>Folio: ${data.folio || ""} ‚Äì ${data.fecha || ""}</h2>
            <p><b>Destino:</b> ${data.destino || ""}</p>
            <p><b>Entrega:</b> ${data.entrega || ""} | <b>Recibe:</b> ${data.recibe || ""}</p>
            <table class="productos">
              <thead><tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th></tr></thead>
              <tbody>
                ${(data.productos || []).map(p=>`
                  <tr><td>${p.codigo || ""}</td><td>${p.descripcion || ""}</td><td>${p.cantidad || 0}</td></tr>
                `).join("")}
              </tbody>
            </table>
            <div class="firmas">
              <div class="firma-box">
                <p>Firma Entrega</p>
                ${data.firmaEntrega ? `<img src="${data.firmaEntrega}">` : "‚Äî"}
              </div>
              <div class="firma-box">
                <p>Firma Recibe</p>
                ${data.firmaRecibe ? `<img src="${data.firmaRecibe}">` : "‚Äî"}
              </div>
            </div>
            <button class="btn-imprimir">üñ® Imprimir</button>
          `;
          div.querySelector(".btn-imprimir").addEventListener("click", ()=>imprimirTarjeta(div));
          contenedor.appendChild(div);
        });
      });
    }
    cargarSalidasTiempoReal();

    // üñ® Imprimir una tarjeta como ticket t√©rmico (vectorial y n√≠tido)
    window.imprimirTarjeta = function(tarjetaEl){
      let payload = null;
      try{ payload = JSON.parse(tarjetaEl.dataset.payload || "null"); }catch(_){}

      if(!payload){
        // fallback DOM ‚Üí no deber√≠a ser necesario, pero por si acaso
        const filas = [...tarjetaEl.querySelectorAll("tbody tr")].map(tr=>{
          const tds = tr.querySelectorAll("td");
          return { codigo: tds[0]?.textContent?.trim()||"", descripcion: tds[1]?.textContent?.trim()||"", cantidad: tds[2]?.textContent?.trim()||"0" };
        });
        const h2 = tarjetaEl.querySelector("h2")?.textContent || "";
        const [folioTxt, fechaTxt] = h2.split("‚Äì").map(s=>(s||"").trim());
        const destino = tarjetaEl.querySelector("p:nth-of-type(1)")?.textContent?.replace("Destino:","").trim() || "";
        const entRec = tarjetaEl.querySelector("p:nth-of-type(2)")?.textContent || "";
        const entrega = (entRec.match(/Entrega:\s*([^|]+)/)||[])[1]?.trim()||"";
        const recibe  = (entRec.match(/Recibe:\s*(.+)$/)||[])[1]?.trim()||"";
        payload = {
          folio: (folioTxt||"").replace("Folio:","").trim(),
          fecha: fechaTxt||"",
          destino, entrega, recibe,
          productos: filas
        };
      }

      const styles = `
        <style>
          :root{ --w-mm:80; --pad-mm:3; --sep:1px dashed #000 } /* cambia 80‚Üí58 si tu impresora es 58mm */
          @page{ size: calc(var(--w-mm)*1mm) auto; margin: 0 }
          *{ box-sizing:border-box }
          body{ margin:0; padding:0; background:#fff; color:#000;
                font: 14px/1.4 ui-monospace, Menlo, "Courier New", monospace; }
          .ticket{ width: calc(var(--w-mm)*1mm); padding: calc(var(--pad-mm)*1mm); }
          .t-center{ text-align:center } .t-right{ text-align:right }
          .h1{ font-weight:700; font-size:16px; letter-spacing:.4px }
          .xs{ font-size:12px } .sm{ font-size:13px }
          .line{ border-top: var(--sep); margin:8px 0 }

          .logo{ display:block; margin:2px auto 6px; width: 45mm; max-width:100%;
                 image-rendering: -webkit-optimize-contrast; }

          .kv{ display:flex; justify-content:space-between; gap:6px; font-size:14px }
          .kv b{ font-weight:700 }

          .th,.tr{ display:flex; gap:2mm; font-size:14px; line-height:1.4 }
          .th{ font-weight:700; border-bottom: var(--sep); padding:3px 0 4px }
          .tr{ padding:3px 0 }
          .col-cod{ width:22mm; white-space:nowrap; overflow:hidden }
          .col-des{ flex:1 1 auto; overflow:hidden }
          .col-cant{ width:12mm; text-align:right }

          .firmas{ display:flex; gap:6mm; margin-top:10px }
          .firma{ flex:1 1 0; text-align:center }
          .firma img{ width: 42mm; max-width:100%; border:1px solid #000; background:#fff }
        </style>
      `;

      const filasHTML = (payload.productos||[]).map(p=>`
        <div class="tr">
          <div class="col-cod">${(p.codigo||'')}</div>
          <div class="col-des">${(p.descripcion||'').toUpperCase()}</div>
          <div class="col-cant">${(p.cantidad||0)}</div>
        </div>
      `).join("");

      const firmasHTML = `
        <div class="firmas">
          <div class="firma">
            <div class="xs">Firma Entrega</div>
            ${payload.firmaEntrega ? `<img src="${payload.firmaEntrega}" alt="Firma Entrega">` : `<div class="xs">‚Äî</div>`}
          </div>
          <div class="firma">
            <div class="xs">Firma Recibe</div>
            ${payload.firmaRecibe ? `<img src="${payload.firmaRecibe}" alt="Firma Recibe">` : `<div class="xs">‚Äî</div>`}
          </div>
        </div>
      `;

      const html = `
        <!DOCTYPE html><html><head><meta charset="UTF-8">
        <title>Ticket ${payload.folio||''}</title>${styles}</head>
        <body>
          <div class="ticket">
            <img class="logo" src="logo_proveedora.webp" alt="Logo La Proveedora">
            <div class="t-center h1">RESUMEN DE SALIDA ‚Äì L√çQUIDOS</div>
            <div class="line"></div>

            <div class="kv"><span><b>Folio:</b> ${payload.folio||''}</span><span class="t-right">${payload.fecha||''}</span></div>
            <div class="kv"><span><b>Entrega:</b> ${payload.entrega||''}</span></div>
            <div class="kv"><span><b>Recibe:</b> ${payload.recibe||''}</span></div>
            <div class="kv"><span><b>Destino:</b> ${payload.destino||''}</span></div>

            <div class="line"></div>
            <div class="th">
              <div class="col-cod">C√ìDIGO</div>
              <div class="col-des">PRODUCTO</div>
              <div class="col-cant">CANT</div>
            </div>
            ${filasHTML}

            <div class="line"></div>
            ${firmasHTML}

            <div class="line"></div>
            <div class="t-center xs">Gracias por su preferencia</div>
          </div>
          <script>window.onload = () => { window.print(); setTimeout(()=>window.close(), 300); }<\/script>
        </body></html>
      `;

      const w = window.open("", "_blank", "width=450,height=700");
      w.document.open(); w.document.write(html); w.document.close();
    }
  </script>
</body>
</html>
